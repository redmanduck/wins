/**********************************************************************
* ?2008 Microchip Technology Inc.
*
* FileName:        SPI_Master.c
* Dependencies:    Header (.h) files if applicable, see below
* Processor:       PIC24Fxxxx
* Compiler:        MPLAB?C30 v3.20 or higher
*
* SOFTWARE LICENSE AGREEMENT:
* Microchip Technology Incorporated ("Microchip") retains all
* ownership and intellectual property rights in the code accompanying
* this message and in all derivatives hereto.  You may use this code,
* and any derivatives created by any person or entity by or on your
* behalf, exclusively with Microchip's proprietary products.  Your
* acceptance and/or use of this code constitutes agreement to the
* terms and conditions of this notice.
*
* CODE ACCOMPANYING THIS MESSAGE IS SUPPLIED BY MICROCHIP "AS IS". NO
* WARRANTIES, WHETHER EXPRESS, IMPLIED OR STATUTORY, INCLUDING, BUT
* NOT LIMITED TO, IMPLIED WARRANTIES OF NON-INFRINGEMENT,
* MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE APPLY TO THIS
* CODE, ITS INTERACTION WITH MICROCHIP'S PRODUCTS, COMBINATION WITH
* ANY OTHER PRODUCTS, OR USE IN ANY APPLICATION.
*
* YOU ACKNOWLEDGE AND AGREE THAT, IN NO EVENT, SHALL MICROCHIP BE
* LIABLE, WHETHER IN CONTRACT, WARRANTY, TORT (INCLUDING NEGLIGENCE OR
* BREACH OF STATUTORY DUTY), STRICT LIABILITY, INDEMNITY,
* CONTRIBUTION, OR OTHERWISE, FOR ANY INDIRECT, SPECIAL, PUNITIVE,
* EXEMPLARY, INCIDENTAL OR CONSEQUENTIAL LOSS, DAMAGE, FOR COST OR
* EXPENSE OF ANY KIND WHATSOEVER RELATED TO THE CODE, HOWSOEVER
* CAUSED, EVEN IF MICROCHIP HAS BEEN ADVISED OF THE POSSIBILITY OR THE
* DAMAGES ARE FORESEEABLE.  TO THE FULLEST EXTENT ALLOWABLE BY LAW,
* MICROCHIP'S TOTAL LIABILITY ON ALL CLAIMS IN ANY WAY RELATED TO THIS
* CODE, SHALL NOT EXCEED THE PRICE YOU PAID DIRECTLY TO MICROCHIP
* SPECIFICALLY TO HAVE THIS CODE DEVELOPED.
*
* You agree that you are solely responsible for testing the code and
* determining its suitability.  Microchip has no obligation to modify,
* test, certify, or support the code.
*
* REVISION HISTORY:
*~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
* Author        Date      	Comments on this revision
*~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
* Albert Z.		3/27/09		first release
*~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
*
* ADDITIONAL NOTES:
*
*
* Code Tested on:
* Explorer 16 Development board with PIC24FJ128GA010.
* The Processor starts with the 8MHz External Crystal (PLL to 16MIPS).
* SPI is worked on 16:1 prescaler = 1MHz.
*
**********************************************************************/

#include "p24fxxxx.h"

#ifdef __PIC24FJ128GA010__	//Defined by MPLAB when using 24FJ256GB110 device
	// JTAG/Code Protect/Write Protect/Clip-on Emulation mode
	// Watchdog Timer/ICD pins select
	_CONFIG1(JTAGEN_OFF & GCP_OFF & GWRP_OFF & COE_OFF & FWDTEN_OFF & ICS_PGx2)
	// Disable CLK switch and CLK monitor, OSCO or Fosc/2, HS oscillator,
	// Primary oscillator
	_CONFIG2(FCKSM_CSDCMD & OSCIOFNC_OFF & POSCMOD_HS & FNOSC_PRIPLL)
#endif

// RB2 as SS for SPI slave MCU
#define CMD_SET_DISP_START_LINE  0x40
#define CMD_SET_PAGE  0xB0

#define CMD_SET_COLUMN_UPPER  0x10
#define CMD_SET_COLUMN_LOWER  0x00

#define CMD_SET_ADC_NORMAL  0xA0
#define CMD_SET_ADC_REVERSE 0xA1

#define CMD_SET_DISP_NORMAL 0xA6
#define CMD_SET_DISP_REVERSE 0xA7

#define CMD_SET_ALLPTS_NORMAL 0xA4
#define CMD_SET_ALLPTS_ON  0xA5
#define CMD_SET_BIAS_9 0xA2
#define CMD_SET_BIAS_7 0xA3

#define CMD_RMW  0xE0
#define CMD_RMW_CLEAR 0xEE
#define CMD_INTERNAL_RESET  0xE2
#define CMD_SET_COM_NORMAL  0xC0
#define CMD_SET_COM_REVERSE  0xC8
#define CMD_SET_POWER_CONTROL  0x28
#define CMD_SET_RESISTOR_RATIO  0x20
#define CMD_SET_VOLUME_FIRST  0x81
#define CMD_SET_VOLUME_SECOND  0
#define CMD_SET_STATIC_OFF  0xAC
#define CMD_SET_STATIC_ON  0xAD
#define CMD_SET_STATIC_REG  0x0
#define CMD_SET_BOOSTER_FIRST  0xF8
#define CMD_SET_BOOSTER_234  0
#define CMD_SET_BOOSTER_5  1
#define CMD_SET_BOOSTER_6  3
#define CMD_NOP  0xE3
#define CMD_TEST  0xF0

#define SPI_SS_TRIS      TRISBbits.TRISB2
#define SPI_SS_PORT      PORTBbits.RB2

unsigned long global_counter;
unsigned char character;

//unsigned short spiBufT[] = {0x0, 0xDEAD, 0xBEEF, 0x0}; // 8 byte
//unsigned short counter = 0;
//unsigned short spiBufR[] = {0, 0, 0, 0}; // SPI buffer for Receiving
void LCD_comm(unsigned char c);
void LCD_data(unsigned char c);
void LCDProcessEvents();
void LCDinit(void);
void SPI2Init(void)
{
    //config SPI2
    SPI2STATbits.SPIEN 		= 0;	// disable SPI port
    SPI2STATbits.SPISIDL 	= 0; 	// Continue module operation in Idle mode

    SPI2BUF 				= 0;   	// clear SPI buffer

    IFS2bits.SPI2IF 		= 0;	// clear interrupt flag
    IEC2bits.SPI2IE 		= 0;	// disable interrupt

    SPI2CON1bits.DISSCK		= 0;	// Internal SPIx clock is enabled
    SPI2CON1bits.DISSDO		= 0;	// SDOx pin is controlled by the module
    SPI2CON1bits.MODE16 	= 0;	// set in 16-bit mode, clear in 8-bit mode
    SPI2CON1bits.SMP		= 0;	// Input data sampled at middle of data output time
    SPI2CON1bits.CKP 		= 0;	// CKP and CKE is subject to change ...
    SPI2CON1bits.CKE 		= 1;	// ... based on your communication mode.
    SPI2CON1bits.MSTEN 		= 1; 	// 1 =  Master mode; 0 =  Slave mode
    SPI2CON1bits.SPRE 		= 4; 	// Secondary Prescaler = 4:1
    SPI2CON1bits.PPRE 		= 2; 	// Primary Prescaler = 4:1

    SPI2CON2 				= 0;	// non-framed mode

	SPI_SS_PORT				= 1;	//
	SPI_SS_TRIS				= 0;	// set SS as output

    SPI2STATbits.SPIEN 		= 1; 	// enable SPI port, clear status
}

unsigned short writeSPI2( unsigned short data )
{
    SPI2BUF = data;					// write to buffer for TX
    while(!SPI2STATbits.SPIRBF);	// wait for transfer to complete
    return SPI2BUF;    				// read the received value
}//writeSPI2

int main (void)
{
	// Disable Watch Dog Timer
	RCONbits.SWDTEN = 0;
	// for LED
	ODCAbits.ODA6 = 0;
	TRISAbits.TRISA6 = 0;
        TRISAbits.TRISA0 = 0;
	SPI2Init();
        LCDinit();
        character = 0;

    
    while (1) {
	   // for (i=0; i<0xffff; i++);	// a simple delay

		//SPI_SS_PORT	= 0;
        /*
		spiBufR[0]	= writeSPI2(spiBufT[0]);
		spiBufR[1]zr	= writeSPI2(spiBufT[1]);
		spiBufR[2]	= writeSPI2(spiBufT[2]);
		spiBufR[3]	= writeSPI2(spiBufT[3]);*/
		//SPI_SS_PORT = 1;
                //PORTAbits.RA0 = 1;
        /*
                a = writeSPI2(0x01);
         *
                writeSPI2(a);
                a = writeSPI2(0x23);
                writeSPI2(a);
                a = writeSPI2(0x45);
                writeSPI2(a);
                a = writeSPI2(0xab);
                writeSPI2(a);
                //writeSPI2(0x5A5A);
*/
        LCDProcessEvents();
        //for(global_counter = 0; global_counter<0xffff; global_counter++);
	__builtin_btg((unsigned int *)&LATA, 6);
        character+=1;
	}

	return 0;
}

void LCDinit(void){
        LCD_comm(CMD_SET_BIAS_9);
        LCD_comm(CMD_SET_ADC_NORMAL);
        LCD_comm(CMD_SET_COM_NORMAL);
        LCD_comm(CMD_SET_DISP_START_LINE);
        LCD_comm(CMD_SET_POWER_CONTROL | 0x4);
        LCD_comm(CMD_SET_POWER_CONTROL | 0x6);
        LCD_comm(CMD_SET_POWER_CONTROL | 0x7);
        LCD_comm(CMD_SET_RESISTOR_RATIO | 0x6);
        LCD_comm(0x25);
        LCD_comm(0x81);
        LCD_comm(0x19);
        LCD_comm(0x2F);
        LCD_comm(0xAF);
        LCD_comm(0xA4);

}

void LCD_comm(unsigned char c){
    unsigned int a = 0;
    PORTAbits.RA0 = 0;
    //for(a = 0; a < 4; a++);
    writeSPI2(c);
    //for(a = 0; a < 4; a++);
}

void LCD_data(unsigned char c){
    unsigned int a = 0;
    PORTAbits.RA0 = 1;
    //for(a = 0; a < 4; a++);
    writeSPI2(c);
    //for(a = 0; a < 4; a++);
}
unsigned int st7565_buffer[1024] = {
  0xFF, 0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x42,
  0xFE,0x02,0x00,0x00,0x00,0x00,0x06,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0xFE,0x20,0x10,0x08,0xFE,0x00,0x3E,0x48,0x88,0x48,0x3E,0x00,0xF8,0x04,0x02,0x04,
  0xF8,0x00,0x00,0x82,0xFE,0x82,0x00,0x00,0x7C,0x82,0x82,0x8A,0xCE,0x00,0x3E,0x48,
  0x88,0x48,0x3E,0x00,0xC0,0x80,0xFE,0x80,0xC0,0x00,0x00,0x82,0xFE,0x82,0x00,0x00,
  0x7C,0x82,0x82,0x82,0x7C,0x00,0xFE,0x20,0x10,0x08,0xFE,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x4E,0x92,
  0x92,0x92,0x62,0x00,0x00,0x00,0x06,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0xFC,0x02,0x1C,0x02,0xFC,0x00,0xFE,0x10,0x10,0x10,0xFE,0x00,0xFE,0x92,0x92,0x92,
  0x82,0x00,0xFE,0x90,0x98,0x94,0x62,0x00,0xFE,0x92,0x92,0x92,0x82,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x3E,0x48,0x88,0x48,0x3E,0x00,0xFE,0x40,0x38,0x40,0xFE,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x82,0xFE,0x82,0x00,0x00,0x40,0x80,0x9A,0x90,
  0x60,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x84,0x82,
  0x92,0xB2,0xCC,0x00,0x00,0x00,0x06,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x64,0x92,0x92,0x92,0x4C,0x00,0xFE,0x10,0x10,0x10,0xFE,0x00,0xFC,0x02,0x02,0x02,
  0xFC,0x00,0xC0,0x80,0xFE,0x80,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFE,0x82,
  0x82,0x82,0x7C,0x00,0x7C,0x82,0x82,0x82,0x7C,0x00,0xFC,0x02,0x1C,0x02,0xFC,0x00,
  0xFE,0x20,0x10,0x08,0xFE,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,};

void LCDProcessEvents()
{
    unsigned char p, c;
    for(p = 0; p < 8; p++){
	LCD_comm(CMD_SET_PAGE | p);
        LCD_comm(CMD_SET_COLUMN_LOWER | 0x00);
        LCD_comm(CMD_SET_COLUMN_UPPER | 0x00);
        for(c = 0; c < 128; c++){
            LCD_comm(CMD_RMW);
            //cmd_rmw
            LCD_data(st7565_buffer[(128*p)+c]);
        }
    }
}
/*
void LCDinit(void){
        LCD_comm(CMD_SET_BIAS_9);
        LCD_comm(CMD_SET_ADC_NORMAL);
        LCD_comm(CMD_SET_COM_NORMAL);
        LCD_comm(CMD_SET_DISP_START_LINE);
        LCD_comm(CMD_SET_POWER_CONTROL | 0x4);
        LCD_comm(CMD_SET_POWER_CONTROL | 0x6);
        LCD_comm(CMD_SET_POWER_CONTROL | 0x7);
        LCD_comm(CMD_SET_RESISTOR_RATIO | 0x6);
        LCD_comm(0x25);
        LCD_comm(0x81);
        LCD_comm(0x19);
        LCD_comm(0x2F);
        LCD_comm(0xAF);
        LCD_comm(0xA4);

}

void LCD_comm(unsigned char c){
    unsigned int a = 0;
    PORTAbits.RA0 = 0;
    //for(a = 0; a < 4; a++);
    writeSPI2(c);
    //for(a = 0; a < 4; a++);
}

void LCD_data(unsigned char c){
    unsigned int a = 0;
    PORTAbits.RA0 = 1;
    //for(a = 0; a < 4; a++);
    writeSPI2(c);
    //for(a = 0; a < 4; a++);
}

void LCDProcessEvents()
{
    unsigned char p, c;
    for(p = 0; p < 8; p++){
	LCD_comm(CMD_SET_PAGE | p);
        LCD_comm(CMD_SET_COLUMN_LOWER | 0x00);
        LCD_comm(CMD_SET_COLUMN_UPPER | 0x00);
        for(c = 0; c < 128; c++){
            LCD_comm(CMD_RMW);
            //cmd_rmw
            LCD_data(character);
        }
    }
}*/